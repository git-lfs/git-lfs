#!/usr/bin/env bash
set -e

UNAME=$(uname -s)

if echo $UNAME | grep -q "_NT-"; then
  WINDOWS=1
  # Now that we know to be on Windows, tell Cygwin / MSYS to
  # really create symbolic links
  if echo $UNAME | grep -q "CYGWIN"; then
    echo "Enabling symbolic links for Cygwin..."
    export CYGWIN="$CYGWIN winsymlinks:nativestrict"
  else
    echo "Enabling symbolic links for MSYS..."
    export MSYS="$MSYS winsymlinks:nativestrict"
  fi
fi

if [ -z "$GOPATH" ]; then
  export GOPATH="$(pwd)"
  mkdir -p src/github.com/git-lfs
  [ -h src/github.com/git-lfs/git-lfs ] ||
    ln -s "$GOPATH" src/github.com/git-lfs/git-lfs
fi

if [ -n "$WINDOWS" ]; then
  echo "Installing goversioninfo to embed resources into Windows executables..."
  go get github.com/josephspurrier/goversioninfo/cmd/goversioninfo
  export PATH=$PATH:$GOPATH/bin/windows_386
  echo "Creating the resource.syso version information file..."
  go generate
fi

script/fmt
rm -rf bin/*
GO15VENDOREXPERIMENT=1 go run script/*.go -cmd build "$@"
